

<!doctype html>
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!-- Consider adding a manifest.appcache: h5bp.com/d/Offline -->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">

  <!-- Use the .htaccess and remove these lines to avoid edge case issues.
       More info: h5bp.com/i/378 -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <title>Rill</title>
  <meta name="description" content="Monitor, maintain, data mine servers.">
  <meta name="author" content="Asim Ihsan">

  <!-- Mobile viewport optimized: h5bp.com/viewport -->
  <meta name="viewport" content="width=device-width">

  <!-- Place favicon.ico and apple-touch-icon.png in the root directory: mathiasbynens.be/notes/touch-icons -->

  <link rel="stylesheet" href="css/style.css">
  <link rel="author" href="/humans.txt" />

  <!-- More ideas for your <head> here: h5bp.com/d/head-Tips -->

  <!-- All JavaScript at the bottom, except this Modernizr build.
       Modernizr enables HTML5 elements & feature detects for optimal performance.
       Create your own custom Modernizr build: www.modernizr.com/download/ -->
  <script src="js/libs/modernizr-2.5.3.min.js"></script>

  <script src="js/libs/jquery-1.7.1.min.js"></script>
  <script src="js/libs/bootstrap.min.js"></script>

</head>
<body>
  <!-- Prompt IE 6 users to install Chrome Frame. Remove this if you support IE 6.
       chromium.org/developers/how-tos/chrome-frame-getting-started -->
  <!--[if lt IE 7]><p class=chromeframe>Your browser is <em>ancient!</em> <a href="http://browsehappy.com/">Upgrade to a different browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to experience this site.</p><![endif]-->

    <div class="navbar">
        <div class="navbar-inner">
            <div class="container">
                <ul class="nav">
                    <li class="active">
                        <a href="#">Queries</a>
                    </li>
                    <li><a href="#">Configure</a></li>
                </ul>
            </div>
        </div>
    </div>        

    <div class="container-fluid">
        <div class="row-fluid">
            <div class="span2">
                <!-- Sidebar contents -->
                <table class="table table-striped table-bordered table-condensed">
                    <tbody>
                        <tr><td><a href="http://mink:8080/ep_error_count">EP error count</a></td></tr>
                        <tr><td><a href="http://mink:8080/full_text_search">Full text search</a></td></tr>
                        <tr><td><a href="http://mink:8080/intel_error_count">Intel error count</a></td></tr>
                        <tr><td><a href="http://mink:8081/">Real time stream</a></td></tr>
                        <tr><td><a href="http://mink:8080/shm_error_count">ShM error count</a></td></tr>
                        <tr><td><a href="http://mink:8080/shm_memory_charts">ShM memory charts</a></td></tr>
                        <tr><td><a href="http://mink:8080/shm_split_brain">ShM split brain</a></td></tr>
                    </tbody>
                </table>
            </div>

            <div class="span10">
            <!-- Body contents -->

<script src="/socket.io/socket.io.js"></script>
<script>

    $(document).ready(function()
    {
        var top_of_page = $('html, body');
        var log_table = $("#log_table");
        var is_connected = false;
        var socket;
        var hostname;
        var has_ever_connected = false;

        var current_include_regexp_filter = new RegExp(".*", "ig");
        var include_regexp_filter_element = $("#include_regexp_filter");
        include_regexp_filter_element.val(".*");
        var include_regexp_filter_control_group_element = $("#include_regexp_filter_control_group");
        var include_regexp_interval_obj;
        var include_regexp_timer_enabled = false;

        var current_exclude_regexp_filter = new RegExp("^$", "ig");
        var exclude_regexp_filter_element = $("#exclude_regexp_filter");
        exclude_regexp_filter_element.val("^$");
        var exclude_regexp_filter_control_group_element = $("#exclude_regexp_filter_control_group");
        var exclude_regexp_interval_obj;
        var exclude_regexp_timer_enabled = false;

        var hostname_select_element = $("#hostname_select");
        hostname_select_element.addClass("warning");

        var pending_log_items = [];
        var pending_log_item_chunk_size = 20;
        var is_pending_log_item_append_running = false;
        var pending_log_item_appender_interval_obj = setInterval(pending_log_item_append, 100);
        function pending_log_item_append()
        {
            if (is_pending_log_item_append_running)
            {
                return;
            }
            var at_bottom_of_screen = false;
            if ($(window).scrollTop() + $(window).height() > $(document).height() - 100)
            {
                at_bottom_of_screen = true;
            }
            is_pending_log_item_append_running = true;
            var items_appended = 0;
            var chunk = "";
            while ((pending_log_items.length > 0) && (items_appended < pending_log_item_chunk_size))
            {
                chunk += pending_log_items.pop();
                items_appended += 1;
            }
            log_table.append(chunk);
            if (at_bottom_of_screen)
            {
                top_of_page.animate({scrollTop:$(document).height()}, 0);
            }
            is_pending_log_item_append_running = false;
        }
        
        include_regexp_filter_element.keyup(function()
        {
            if (include_regexp_timer_enabled)
            {
                clearInterval(include_regexp_interval_obj);
            }
            include_regexp_interval_obj = setInterval(update_regexp, 1000);
            include_regexp_timer_enabled = true;
        });

        exclude_regexp_filter_element.keyup(function()
        {
            if (exclude_regexp_timer_enabled)
            {
                clearInterval(exclude_regexp_interval_obj);
            }
            exclude_regexp_interval_obj = setInterval(update_regexp, 1000);
            exclude_regexp_timer_enabled = true;
        });

        function update_regexp()
        {
            // ---------------------------------------------------------------
            //  Update the include regular expression, if it was being
            //  updated.
            // ---------------------------------------------------------------
            if (include_regexp_timer_enabled)
            {
                clearInterval(include_regexp_interval_obj);
                include_regexp_timer_enabled = false;
                var text_val = include_regexp_filter_element.val();
                if (text_val == "")
                {
                    text_val = ".*";
                }
                try
                {
                    var possible_include_regexp_filter = new RegExp(text_val, "ig");
                    include_regexp_filter_control_group_element.removeClass("error");
                    current_include_regexp_filter = possible_include_regexp_filter;
                }
                catch (e)
                {
                    include_regexp_filter_control_group_element.addClass("error");
                }
            }
            // ---------------------------------------------------------------

            // ---------------------------------------------------------------
            //  Update the exclude regular expression, if it was being
            //  updated.
            // ---------------------------------------------------------------
            if (exclude_regexp_timer_enabled)
            {
                clearInterval(exclude_regexp_interval_obj);
                exclude_regexp_timer_enabled = false;
                var text_val = exclude_regexp_filter_element.val();
                if (text_val == "")
                {
                    text_val = "^$";
                }
                try
                {
                    var possible_exclude_regexp_filter = new RegExp(text_val, "ig");
                    exclude_regexp_filter_control_group_element.removeClass("error");
                    current_exclude_regexp_filter = possible_exclude_regexp_filter;
                }
                catch (e)
                {
                    exclude_regexp_filter_control_group_element.addClass("error");
                }
            }
            // ---------------------------------------------------------------

            // ---------------------------------------------------------------
            //  Re-apply both include and exclude regular expressions
            //  to all log rows.
            // ---------------------------------------------------------------
            log_table.children().each(function(index, element)
            {
                if (current_include_regexp_filter.test($(this).text()) &&
                    !current_exclude_regexp_filter.test($(this).text()))
                {
                    $(this).css({'display': ''});
                }
                else
                {
                    $(this).css({'display': 'none'});
                }
            });
            // ---------------------------------------------------------------
        }

        $("#hostname").change(function()
        {
            hostname = $("#hostname option:selected").val();
            console.log("hostname selection changes to: " + hostname);
            pending_log_items = [];
            if (is_connected)
            {
                socket.disconnect();
                $("#log_table").empty();
                is_connected = false;
            }
            hostname_select_element.removeClass("success");
            hostname_select_element.addClass("warning");
            setTimeout(connect_to_real_time_server, 100);
        });
        $("#hostname").prop("selectedIndex", -1);

        function connect_to_real_time_server()
        {
            console.log("connect_to_real_time_server entry for hostname: " + hostname);
            if (!has_ever_connected)
            {
                socket = io.connect("http://localhost:8081");
                socket = io.connect(null,{'force new connection':true});
                has_ever_connected = true;
            }
            else
            {
                socket = io.connect(null,{'force new connection':true});
            }
            socket.on('hostname_selection', function()
            {
                console.log("emitting hostname selection: " + hostname);
                socket.emit("hostname_selection", JSON.stringify(hostname));
                hostname_select_element.addClass("success");
                hostname_select_element.removeClass("warning");
            });
            is_connected = true;

            socket.on('log', function(data)
            {
                if (is_connected)
                {
                    var text_to_insert = "";
                    text_to_insert += "<li style=\"background: ";
                    text_to_insert += data.color;
                    text_to_insert += "; ";
                    if ((current_include_regexp_filter.test(data.contents)) &&
                        !(current_exclude_regexp_filter.test(data.contents)))
                    {
                        //text_to_insert += "display: block;";
                    }
                    else
                    {
                        text_to_insert += "display: none;";
                    }
                    text_to_insert += "\">";
                    text_to_insert +=  data.contents;
                    text_to_insert += "</li>";
                    pending_log_items.unshift(text_to_insert);

                } // if is_connected
            }); // on socket connect
        }
    });

</script>

<h2>Real time stream</h2>

<form class="well">
    <div id="hostname_select" class="control-group">
        <label>Hostname</label>
        <select name="hostname" id="hostname">
            <option value="andromeda">ShM - andromeda</option>
            <option value="crux">ShM - crux</option>
            <option value="dorado">ShM - dorado</option>
            <option value="draco">ShM - draco</option>
            <option value="gemini">ShM - gemini</option>
            <option value="leo">ShM - leo</option>
            <option value="lupus">ShM - lupus</option>
            <option value="scorpius">ShM - scorpius</option>
            <option value="tucana">ShM - tucana</option>
            <option value="vulpecula">ShM - vulpecula</option>
            <option value="alpheratz">NGMG - alpheratz</option>
            <option value="altais">NGMG - alatais</option>
            <option value="arrakis">NGMG - arrakis</option>
            <option value="jabbah">NGMG - jabbah</option>
            <option value="juza">NGMG - juza</option>
            <option value="rastaban">NGMG - rastaban</option>
            <option value="subra">NGMG - subra</option>
            <option value="wolf">NGMG - wolf</option>
            <option value="zosma">NGMG - zosma</option>
        </select>
    </div>
    <div id="include_regexp_filter_control_group" class="control-group">
        <label>Include regular expression filter</label>
        <input id="include_regexp_filter" name="include_regexp_filter" type="text" class="span3" placeholder="e.g. '.*' or '(failed|exception)'"></input>
    </div>
    <div id="exclude_regexp_filter_control_group" class="control-group">
        <label>Exclude regular expression filter</label>
        <input id="exclude_regexp_filter" name="exclude_regexp_filter" type="text" class="span3" placeholder="e.g. '^$' or '(callbacks)'"></input>
    </div>
</form>

<p><ul class="unstyled mono" id="log_table"></ul></p>

</div>
</div>
</div>

  <!-- scripts concatenated and minified via build script -->
  <script src="js/plugins.js"></script>
  <script src="js/script.js"></script>
  <!-- end scripts -->

</body>
</html>
