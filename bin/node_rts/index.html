

<!doctype html>
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!-- Consider adding a manifest.appcache: h5bp.com/d/Offline -->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">

  <!-- Use the .htaccess and remove these lines to avoid edge case issues.
       More info: h5bp.com/i/378 -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <title>Rill</title>
  <meta name="description" content="Monitor, maintain, data mine servers.">
  <meta name="author" content="Asim Ihsan">

  <!-- Mobile viewport optimized: h5bp.com/viewport -->
  <meta name="viewport" content="width=device-width">

  <!-- Place favicon.ico and apple-touch-icon.png in the root directory: mathiasbynens.be/notes/touch-icons -->

  <link rel="stylesheet" href="css/style.css">
  <link rel="author" href="/humans.txt" />

  <!-- More ideas for your <head> here: h5bp.com/d/head-Tips -->

  <!-- All JavaScript at the bottom, except this Modernizr build.
       Modernizr enables HTML5 elements & feature detects for optimal performance.
       Create your own custom Modernizr build: www.modernizr.com/download/ -->
  <script src="js/libs/modernizr-2.5.3.min.js"></script>

  <script src="js/libs/jquery-1.7.1.min.js"></script>
  <script src="js/libs/bootstrap.min.js"></script>

</head>
<body>
  <!-- Prompt IE 6 users to install Chrome Frame. Remove this if you support IE 6.
       chromium.org/developers/how-tos/chrome-frame-getting-started -->
  <!--[if lt IE 7]><p class=chromeframe>Your browser is <em>ancient!</em> <a href="http://browsehappy.com/">Upgrade to a different browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to experience this site.</p><![endif]-->

    <div class="navbar">
        <div class="navbar-inner">
            <div class="container">
                <ul class="nav">
                    <li class="active">
                        <a href="#">Queries</a>
                    </li>
                    <li><a href="#">Configure</a></li>
                </ul>
            </div>
        </div>
    </div>        

    <div class="container-fluid">
        <div class="row-fluid">
            <div class="span2">
                <!-- Sidebar contents -->
                <table class="table table-striped table-bordered table-condensed">
                    <tbody>
                        <tr><td><a href="http://mink:8080/ep_error_count">EP error count</a></td></tr>
                        <tr><td><a href="http://mink:8080/full_text_search">Full text search</a></td></tr>
                        <tr><td><a href="http://mink:8081/">Real time stream</a></td></tr>
                        <tr><td><a href="http://mink:8080/shm_memory_charts">ShM memory charts</a></td></tr>
                        <tr><td><a href="http://mink:8080/shm_split_brain">ShM split brain</a></td></tr>
                    </tbody>
                </table>
            </div>

            <div class="span10">
            <!-- Body contents -->

<script src="/socket.io/socket.io.js"></script>
<script>

    $(document).ready(function()
    {
        var top_of_page = $('body');
        var log_table = $("#log_table");
        var is_connected = false;
        var socket;
        var hostname;
        var has_ever_connected = false;

        var current_regexp_filter = new RegExp(".*", "ig");
        var regexp_filter_element = $("#regexp_filter");
        regexp_filter_element.val("");
        var regexp_filter_control_group_element = $("#regexp_filter_control_group");
        var regexp_interval_obj;
        var regexp_timer_enabled = false;

        var hostname_select_element = $("#hostname_select");
        hostname_select_element.addClass("warning");
        
        regexp_filter_element.keyup(function()
        {
            if (regexp_timer_enabled)
            {
                clearInterval(regexp_interval_obj);
            }
            regexp_interval_obj = setInterval(update_regexp, 1000);
            regexp_timer_enabled = true;
        });

        function update_regexp()
        {
            clearInterval(regexp_interval_obj);
            regexp_timer_enabled = false;
            var text_val = regexp_filter_element.val();
            try
            {
                var possible_regexp_filter = new RegExp(text_val, "ig");
            }
            catch (e)
            {
                regexp_filter_control_group_element.addClass("error");
                return;
            }
            regexp_filter_control_group_element.removeClass("error");
            current_regexp_filter = possible_regexp_filter;
            log_table.children().each(function(index, element)
            {
                if (current_regexp_filter.test($(this).text()))
                {
                    $(this).css({'display': 'block'});
                }
                else
                {
                    $(this).css({'display': 'none'});
                }
            });
        }

        $("#hostname").change(function()
        {
            hostname = $("#hostname option:selected").val();
            console.log("hostname selection changes to: " + hostname);
            if (is_connected)
            {
                socket.disconnect();
                $("#log_table").empty();
                is_connected = false;
            }
            hostname_select_element.removeClass("success");
            hostname_select_element.addClass("warning");
            setTimeout(connect_to_real_time_server, 100);
        });
        $("#hostname").prop("selectedIndex", -1);

        function connect_to_real_time_server()
        {
            console.log("connect_to_real_time_server entry for hostname: " + hostname);
            if (!has_ever_connected)
            {
                socket = io.connect("http://localhost:8081");
                socket = io.connect(null,{'force new connection':true});
                has_ever_connected = true;
            }
            else
            {
                socket = io.connect(null,{'force new connection':true});
            }
            socket.on('hostname_selection', function()
            {
                console.log("emitting hostname selection: " + hostname);
                socket.emit("hostname_selection", JSON.stringify(hostname));
                hostname_select_element.addClass("success");
                hostname_select_element.removeClass("warning");
            });
            is_connected = true;

            var maximum_logs = 100000;
            socket.on('log', function(data)
            {
                if (is_connected)
                {
                    var text_to_insert = [];
                    var i = 0;
                    text_to_insert[i++] = "<tr style=\"background: "
                    text_to_insert[i++] = data.color;
                    text_to_insert[i++] = ";\"><td>";
                    text_to_insert[i++] = data.contents;
                    text_to_insert[i++] = "</td></tr>";
                    log_table.append(text_to_insert.join(''));
                    rows = log_table.children();
                    if (rows.length > maximum_logs)
                    {
                        rows.slice(0, 1).remove();
                    }
                    var last_child = rows.last();
                    if (!current_regexp_filter.test(data.contents))
                    {
                        last_child.css({'display': 'none'});
                    }
                    if ($(window).scrollTop() + $(window).height() > $(document).height() - 100)
                    {
                        top_of_page.animate({scrollTop:$(document).height()}, 100);
                    }
                } // if is_connected
            }); // on socket connect
        }
    });

</script>

<h2>Real time stream</h2>

<form class="well">
    <div id="hostname_select" class="control-group">
        <label>Hostname</label>
        <select name="hostname" id="hostname">
            <option value="andromeda">ShM - andromeda</option>
            <option value="draco">ShM - draco</option>
            <option value="gemini">ShM - gemini</option>
            <option value="leo">ShM - leo</option>
            <option value="scorpius">ShM - scorpius</option>
            <option value="alpheratz">NGMG - alpheratz</option>
            <option value="altais">NGMG - alatais</option>
            <option value="arrakis">NGMG - arrakis</option>
            <option value="jabbah">NGMG - jabbah</option>
            <option value="juza">NGMG - juza</option>
            <option value="rastaban">NGMG - rastaban</option>
        </select>
    </div>
    <div id="regexp_filter_control_group" class="control-group">
        <label>Regular expression filter</label>
        <input id="regexp_filter" name="regexp_filter" type="text" class="span3" placeholder="e.g. '.*' or '(failed|exception)'"></input>
    </div>
</form>

<p>
    <table class="table table-condensed">
        <tbody class="mono" id="log_table"></tbody>
    </table>
</p>

</div>
</div>
</div>

  <!-- scripts concatenated and minified via build script -->
  <script src="js/plugins.js"></script>
  <script src="js/script.js"></script>
  <!-- end scripts -->

</body>
</html>
